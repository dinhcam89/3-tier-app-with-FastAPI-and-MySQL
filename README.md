# Secure FastAPI Application with MySQL Backend and NGINX Reverse Proxy

This guide provides step-by-step instructions to set up a secure FastAPI application that connects to a MySQL database, with NGINX acting as a reverse proxy. The API is secured using JWT tokens for authentication.

---

## Prerequisites

- **Bastion Host**: Running NGINX for reverse proxy and SSL termination.
- **App Instance**: Hosting the FastAPI app.
- **DB Instance**: Running MySQL to store data.
- **External Instance**: Outside VPC, hosting phpMyAdmin to access to DB instance to manage MySQL Database
- **Domain**: `api.lab.aandd.io` (or your own domain).

---

## Steps to Complete the Setup

### 1. **Set Up Squid Forward Proxy on Bastion Instance**
- Install Squid
```bash
sudo apt update && sudo apt install squid -y
```
- Configure Squid Forward Proxy
Edit /etc/squid/squid.conf and add the following:
```bash
# src ip definition
acl allowed_ips src 10.100.0.101
acl allowed_ips src 10.100.0.100
# allow access
http_access allow allowed_ips
http_access allow CONNECT SSL_ports
http_access deny all
```
- Configure Proxy Address on two Private Instances:
  - Edit /etc/environment and add the following:
```bash
export http_proxy=http://10.100.0.100:3128
export https_proxy=http://10.100.0.100:3128
```
### 2. **Install and Configure a Private DNS Server with BIND9 on the Bastion Instance**
#### Install BIND9
```bash
sudo apt update
sudo apt install bind9 bind9utils bind9-doc -y
```
#### Configure Private DNS Server for `.instance.local` domain:
- Create file /etc/bind/zones/db.instance.local and add the following lines:
```bash
$TTL 604800
@   IN  SOA instance.local. root.instance.local. (
        2         ; Serial
        604800    ; Refresh
        86400     ; Retry
        2419200   ; Expire
        604800 )  ; Negative Cache TTL

; Name server
@   IN  NS  ns.instance.local.

; A record for the name server
ns IN  A   10.100.4.50

; DNS records for instances
app IN  A   10.100.0.100
db  IN  A   10.100.0.101
```

### 3. **Set Up MySQL on the DB Instance**

#### Install MySQL:
```bash
sudo apt update
sudo apt install mysql-server
```
#### Create Database `test_db` and an user to manage it
```SQL
-- Create Database
CREATE DATABASE test_db;
USE test_db;
CREATE TABLE items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price FLOAT NOT NULL,
    quantity INT NOT NULL,
    description TEXT
);

-- Create User and grant permission on test_db database
CREATE USER 'user'@'%' IDENTIFIED WITH mysql_native_password BY 'password';
GRANT ALL PRIVILEGES ON test_db.* TO 'user'@'%';
FLUSH PRIVILEGES;
```
### 4. **Configure NGINX Reverse Proxy on Bastion Host**
#### Install Nginx:
```bash
sudo apt update && sudo apt install nginx -y
```
#### Install certbot and generate SSL certificate for `api.lab.aandd.io` domain:
- Install certbot:
```bash
sudo apt install certbot python3-certbot-nginx -y
```
- Generate SSL certificate:
```bash
sudo certbot --nginx -d api.lab.aandd.io
```
#### Configure NGINX as Reverse Proxy for FastAPI and SSL:
- Create a file at /etc/nginx/sites-available/api.lab.aandd.io
```bash
server {
    listen 80;
    server_name api.lab.aandd.io;

    location / {
        proxy_pass http:/App-Instance-Private-IP:8000;  # App instance private IP and Fast API port
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Redirect HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name api.lab.aandd.io;

    # add ssl certificate generated by certbot from above step
    ssl_certificate /etc/letsencrypt/live/api.lab.aandd.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.lab.aandd.io/privkey.pem;

    location / {
        proxy_pass http://app.instance.local:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
#### Configure NGINX as Reverse Proxy for MySQL access from External Instance:
- Edit file /etc/nginx/nginx.conf and add the following block of configurations:
```bash
# Stream block for MySQL
stream {
    upstream mysql_backend {
        server db.instance.local:3306;
    }

    server {
        listen 3306;
        proxy_pass mysql_backend;
        proxy_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_buffer_size 16k;
    }
}
```

#### Enable and Restart NGINX:
```bash
sudo ln -s /etc/nginx/sites-available/api.lab.aandd.io /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 5. **Install and Configure FastAPI (App Instance)**
#### Install FastAPI and Dependencies:
```bash
sudo apt update && sudo apt install python3-pip python3-venv -y
python3 -m venv venv
source venv/bin/activate # active python virtual env
pip install fastapi uvicorn pymysql jose python-multipart
```
#### Run FastAPI app
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```
- Access `https://api.lab.aandd.io/docs` for API docs and execution

### 6. **Install and configure phpMyAdmin on External Client**
- Install phpMyAdmin
```bash
sudo apt update && sudo apt install phpmyadmin -y
```
- Configure phpMyAdmin to Access Through Bastion Proxy:
  - Edit /etc/phpmyadmin/config.inc.php and set the following:
  ```bash
    # config remote mysql database
    $i++;
    $cfg['Servers'][$i]['host'] = 'api.lab.aandd.io:3306'; #provide hostname and port if other than default
    $cfg['Servers'][$i]['user'] = '';   #username for your remote server
    $cfg['Servers'][$i]['password'] = '';  #password
    $cfg['Servers'][$i]['auth_type'] = 'cookie';       #keep it as config
  ```
- Install and Configure Nginx Webserver for phpMyAdmin
  - Install NGINX:
  ```bash
  sudo apt update
  sudo apt install nginx -y  
  ```
  - Create file /etc/nginx/sites-enabled/phpmyadmin and add the following lines:
  ```bash
  server {
    listen 80;
    server_name 18.142.15.207;  # Use your own domain for phpMyAdmin

    # Path to the phpMyAdmin installation
    root /usr/share/phpmyadmin;
    index index.php index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }

    # Handle PHP files with PHP-FPM
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;  # Make sure to use the correct PHP version
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Block access to sensitive files
    location ~ /\.ht {
        deny all;
    }

    # Enable access to phpMyAdmin's configuration storage
    location /setup {
        root /usr/share/phpmyadmin;
        index index.php;
    }
  }
    ```
  - Enable the Configuration with a symbolic link to enable the site:
  ```bash
  sudo ln -s /etc/nginx/sites-available/phpmyadmin /etc/nginx/sites-enabled/
  ```
  - Test and Reload Nginx configuration:
  ```bash
  sudo nginx -t
  sudo systemctl reload nginx
  ```
- Access phpMyAdmin:
  - Navigate to http://external_ip/ and log in using your MySQL credentials.

